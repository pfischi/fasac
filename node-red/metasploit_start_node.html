<script type="text/javascript">
    RED.nodes.registerType('Metasploit: Start',{
        category: 'FASAC',
        color: '#a6bbcf',
        inputs: 1,
        outputs: 3,
        icon: "file.png",
        outputLabels: [
            "job success",
            "job failed (partially)",
            "stdout",
        ],
        defaults: {
            name: {value: ""},
            awxService: {type:"awx-config", required: true},
            clusterService: {type:"cluster-config", required: true},
            jobTimeout: {required:true, value: 300, validate:RED.validators.number()},
            persistence: {value: false, required: true},
            persistenceStorage: {value: 100, required: false},
            msfrpcdSSL: {value: true, required: false},
            msfrpcdUser: {value: "msf", required: true},
            msfrpcdPassword: {value: "msf", required: true},
            helmReleaseName: {
                value: "",
                required: true,
                validate:function (value) {
                    const pattern =  /(?=^.{0,23}$)^[a-z]([-a-z0-9]*[a-z0-9])$/g;
                    const valid952HostnameRegex = new RegExp(pattern);
                    return valid952HostnameRegex.test(value);
                }
            },
            metasploitServiceName: {
                value: "",
                required: true,
                validate:function (value) {
                    const pattern =  /(?=^.{0,23}$)^[a-z]([-a-z0-9]*[a-z0-9])$/g;
                    const valid952HostnameRegex = new RegExp(pattern);
                    return valid952HostnameRegex.test(value);
                }
            },
            msfrpcdPort: {value: 55553, required: true, validate:RED.validators.regex(/^()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$/)},
            tcpBackConnect1: {value: 10000, required: true, validate:RED.validators.regex(/^()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$/)},
            tcpBackConnect2: {value: 10001, required: true, validate:RED.validators.regex(/^()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$/)},
            tcpBackConnect3: {value: 10002, required: true, validate:RED.validators.regex(/^()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$/)},
            tcpBackConnect4: {value: 10003, required: true, validate:RED.validators.regex(/^()([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5])$/)},
        },
        label: function() {
            return this.name||"Metasploit: Start";
        },
        oneditprepare() {
            if($("#node-input-helmReleaseName").val().length === 0) {
                $("#node-input-helmReleaseName").val(function () {
                    const n1 = ["blue", "green", "red", "orange", "violet", "indigo", "yellow"];
                    const n2 = ["one", "two", "three", "four", "five", "fix", "seven", "eight", "nine", "zero"]
                    return n1[parseInt(Math.random() * n1.length)] + '-' + n2[parseInt(Math.random() * n2.length)] + Math.floor(Math.random() * 1000);
                })
            }

            if($("#node-input-metasploitServiceName").val().length === 0) {
                $("#node-input-metasploitServiceName").val(function () {
                    const n1 = ["blue", "green", "red", "orange", "violet", "indigo", "yellow"];
                    const n2 = ["one", "two", "three", "four", "five", "fix", "seven", "eight", "nine", "zero"]
                    return n1[parseInt(Math.random() * n1.length)] + '-' + n2[parseInt(Math.random() * n2.length)] + Math.floor(Math.random() * 1000);
                })
            }

            $("#node-input-persistence").change( function () {
                if (this.checked) {
                    $("#persistenceDiv").show();
                } else {
                    $("#persistenceDiv").hide();
                }
            });
        }
    });
</script>

<script type="text/html" data-template-name="Metasploit: Start">
    <style>
        .divPassword {
            margin-top: 5px;
        }
    </style>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-awxService"><i class="fa fa-tag"></i> AWX Server</label>
        <input type="text" id="node-input-awxService" placeholder="AWX Server">
    </div>
    <div class="form-row">
        <label for="node-input-clusterService"><i class="fa fa-tag"></i> Kubernetes Cluster</label>
        <input type="text" id="node-input-clusterService" placeholder="Kubernetes Cluster">
    </div>
    <div class="form-row">
        <label for="node-input-helmReleaseName"><i class="fa fa-tag"></i> Helm Release Name</label>
        <input type="text" id="node-input-helmReleaseName" placeholder="Helm Release Name">
    </div>
    <div class="form-row">
        <label for="node-input-metasploitServiceName"><i class="fa fa-tag"></i> Metasploit Service Name</label>
        <input type="text" id="node-input-metasploitServiceName" placeholder="Metasploit Service Name">
    </div>

    <div class="form-row">
        <label for="node-input-msfrpcdUser"><i class="fa fa-tag"></i> MSFRPCD User</label>
        <input type="text" id="node-input-msfrpcdUser" placeholder="msf">
    </div>
    <div class="form-row">
        <label for="node-input-msfrpcdUser"><i class="fa fa-tag"></i> MSFRPCD Password</label>
        <input type="text" id="node-input-msfrpcdPassword" placeholder="msf">
    </div>
    <div class="form-row">
        <label for="node-input-msfrpcdPort"><i class="fa fa-globe"></i>MSFRPCD Port</label>
        <input type="number" id="node-input-msfrpcdPort">
    </div>
    <div class="form-row">
        <label for="node-input-msfrpcdSSL"><i class="fa fa-tag"></i>SSL</label>
        <input type="checkbox" id="node-input-msfrpcdSSL">
    </div>
    <div class="form-row">
        <label for="node-input-tcpBackConnect1"><i class="fa fa-tag"></i>TCP Backconnect Port 1</label>
        <input type="number" id="node-input-tcpBackConnect1">
    </div>
    <div class="form-row">
        <label for="node-input-tcpBackConnect2"><i class="fa fa-tag"></i>TCP Backconnect Port 2</label>
        <input type="number" id="node-input-tcpBackConnect2">
    </div>
    <div class="form-row">
        <label for="node-input-tcpBackConnect3"><i class="fa fa-tag"></i>TCP Backconnect Port 3</label>
        <input type="number" id="node-input-tcpBackConnect3">
    </div>
    <div class="form-row">
        <label for="node-input-tcpBackConnect4"><i class="fa fa-tag"></i>TCP Backconnect Port 4</label>
        <input type="number" id="node-input-tcpBackConnect4">
    </div>
    <div class="form-row">
        <label for="node-input-jobTimeout"><i class="fa fa-tag"></i> Job Timeout</label>
        <input type="text" id="node-input-jobTimeout" placeholder="">
    </div>
    
</script>

<script type="text/markdown" data-help-name="metasploit-start">
Creates a file.

### Inputs

: msg.payload (dictionary):  A dictionary containing the parameter for creating the file.

### Outputs

1. Standard output
: msg.payload (string) : The standard output of the executed ansible job.

2. Job success
: msg.payload (list) : A list of job results if the job was finished successfully.

3. Job failed (partially)
: msg.payload (list) : A list of job results if the job failed (partially).

### Details

The following attributes can be set via `msg.payload`:

```
{
    path: "/example/path"                       # required, must be an absoulte file path
    mode: "0644",                               # optional, file mode
    owner: "user",                              # optional, owner of the file
    group: "usergroup",                         # optional, group of the file
    content: "This is the file content."        # optional, plain text or base64-encoded string, default: false
    isBase64Content: true | false               # optional, if true the content will be base64-decoded on the host
}
```
If the file already exists, it will be overwritten with the given content value. To modify the file attributes use 
the "Modify File" node.

### References

Structure of a job response: https://docs.ansible.com/ansible-tower/3.2.3/html/towerapi/job_list.html#results

Ansible copy module: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html
</script>