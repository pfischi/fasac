<script type="text/javascript">
    RED.nodes.registerType('mailserver-start',{
        category: 'FASAC',
        color: '#a6bbcf',
        inputs: 1,
        outputs: 3,
        icon: "file.png",
        outputLabels: [
            "job success",
            "job failed (partially)",
            "stdout",
        ],
        defaults: {
            onload: {value: true},
            name: {value: ""},
            awxService: {type:"awx-config", required: true},
            clusterService: {type:"cluster-config", required: true},
            jobTimeout: {required:true, value: 120, validate:RED.validators.number()},
            persistence: {value: false, required: true},
            persistenceStorage: {value: 100, required: false},
            mailServiceName: {
                value: "",
                required: true,
                validate:function (value) {
                    const pattern =  /(?=^.{0,23}$)^[a-z]([-a-z0-9]*[a-z0-9])$/g;
                    const valid952HostnameRegex = new RegExp(pattern);
                    return valid952HostnameRegex.test(value);
                }
            },
            helmReleaseName: {
                value: "",
                required: true,
                validate:function (value) {
                    const pattern =  /(?=^.{0,23}$)^[a-z]([-a-z0-9]*[a-z0-9])$/g;
                    const valid952HostnameRegex = new RegExp(pattern);
                    return valid952HostnameRegex.test(value);
                }
            },
            mailUsers: {value: "", required: true, validate: function(v) {
                    //check for duplicate usernames in array and empty values
                    const usernames = [];
                    for (const [key, value] of Object.entries(v)) {
                        if (value.user.length ===0 || value.password.length === 0) {
                            return false;
                        }
                        if (usernames.includes(value.user)) {
                            return false;
                        }
                        usernames.push(value.user);
                    }
                    return true;
                }
            }
        },
        label: function() {
            return this.name||"Mailserver Start";
        },
        oneditprepare() {
            if($("#node-input-helmReleaseName").val().length === 0) {
                $("#node-input-helmReleaseName").val(function () {
                    const n1 = ["blue", "green", "red", "orange", "violet", "indigo", "yellow"];
                    const n2 = ["one", "two", "three", "four", "five", "fix", "seven", "eight", "nine", "zero"]
                   return n1[parseInt(Math.random() * n1.length)] + '-' + n2[parseInt(Math.random() * n2.length)] + Math.floor(Math.random() * 1000);
                })
            }

            var onload = true;
            var mailList = $('#node-input-mail-container').css('min-height','250px').css('min-width','450px').editableList({
                sortable: true,
                removable: true,
                addItem: (container, i, data) => {
                    const config = RED.nodes.node($("#node-input-clusterService").val())
                    if(Object.keys(data).length === 0) {
                        data.user = "";
                        data.password = "";
                    }

                    const inputUser = $('<input class="input-user" type="text" value="' + data.user + '">');
                    const inputPassword = $('<input class="input-pass" type="text" value="' + data.password + '">');

                    const mailEntry = $('<div></div>');
                    const userEntry = $('<div class="form-row">');
                    const toolTip = $('<div class="form-row">');
                    userEntry.append('<label>User</label>');
                    userEntry.append(inputUser);

                    const passwordEntry = $('<div class="form-row divPassword">');
                    passwordEntry.append('<label>Password</label>');
                    passwordEntry.append(inputPassword);

                    toolTip.append('<label>Mail Address</label>');
                    toolTip.append('<input readonly class="form-row blue input-mailAddress" type="text" value="' +
                        data.user + '@' +
                        document.getElementById("node-input-mailServiceName").value + '.' +
                        config.namespace +
                        '.svc.' +
                        config.clusterName +
                        '">');

                    mailEntry.append(userEntry);
                    mailEntry.append(passwordEntry);
                    mailEntry.append(toolTip);
                    mailEntry.appendTo(container);

                    inputUser.on("change keyup paste", function() {
                        // create mail address
                        const config = RED.nodes.node($("#node-input-clusterService").val())
                        const mailAddress =
                            $(this).val() + '@' +
                            document.getElementById("node-input-mailServiceName").value + '.' +
                            config.namespace +
                            '.svc.' +
                            config.clusterName;

                        $(this).parent().parent().find('input.input-mailAddress').val(mailAddress)

                        const userName = this.value;
                        const userFields = mailList.find('input.input-user').filter(function() {
                            return this.value === userName;
                        })
                        if (userFields.length > 1) {
                            $(this).css('border', '1px solid rgb(214, 97, 95)');
                        }
                        else {
                            $(this).css('border', '');
                        }
                    });
                    inputUser.prop('required',true);
                    inputPassword.prop('required',true);
                }
            });

            $("#node-input-clusterService").change(function() {
                var config = RED.nodes.node($(this).val())
                $('#node-input-mail-container').find('input.input-user').each(function( index ) {
                    console.log(this)
                    const mailAddress =
                        $(this).val() + '@' +
                        document.getElementById("node-input-mailServiceName").value + '.' +
                        config.namespace +
                        '.svc.' +
                        config.clusterName;
                    $(this).parent().parent().find('input.input-mailAddress').val(mailAddress)
                });
            });

            $("#node-input-mailServiceName").on('change paste keyup', function(event, type, value) {
                const users = [];
                if (!onload) {
                    $('#node-input-mail-container').editableList('items').each(function () {
                        const u = $(this).find('input.input-user').val();
                        const p = $(this).find('input.input-pass').val();
                        users.push({
                            user: u,
                            password: p
                        });
                    });
                    $("#node-input-mail-container").editableList('empty');
                    Object.entries(users).forEach(([index, val]) => {
                        const user = val.user;
                        const password = val.password
                        $('#node-input-mail-container').editableList('addItem', {user, password});
                    })
                }
                onload = false;
            });

            Object.entries(this.mailUsers).forEach(([index,value]) => {
                const user = value.user;
                const password = value.password
                $('#node-input-mail-container').editableList('addItem', {user, password});
            });

            $("#node-input-persistence").change( function () {
                if (this.checked) {
                    $("#persistenceDiv").show();
                } else {
                    $("#persistenceDiv").hide();
                }
            });
        },
        oneditsave() {
            const users = [];
            $('#node-input-mail-container').editableList('items').each(function () {
                const u = $(this).find('input.input-user').val();
                const p = $(this).find('input.input-pass').val();
                users.push({
                    user: u,
                    password: p
                });
            });
            this.mailUsers = users;
        }
    });
</script>

<script type="text/html" data-template-name="mailserver-start">
    <style>
        .divPassword {
            margin-top: 5px;
        }
        input.blue {
            color: blue;
            -webkit-text-fill-color: blue
        }
    </style>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-awxService"><i class="fa fa-tag"></i> AWX Server</label>
        <input type="text" id="node-input-awxService" placeholder="AWX Server">
    </div>
    <div class="form-row">
        <label for="node-input-clusterService"><i class="fa fa-tag"></i> Kubernetes Cluster</label>
        <input type="text" id="node-input-clusterService" placeholder="Kubernetes Cluster">
    </div>
    <div class="form-row">
        <label for="node-input-helmReleaseName"><i class="fa fa-tag"></i> Helm Release Name</label>
        <input type="text" id="node-input-helmReleaseName" placeholder="Helm Release Name">
    </div>
    <div class="form-row">
        <label for="node-input-mailServiceName"><i class="fa fa-tag"></i> Mail Service Name</label>
        <input type="text" id="node-input-mailServiceName" placeholder="Mail Service Name">
    </div>
<!--    <div class="form-row">
        <label for="node-input-persistence"><i class="fa fa-tag"></i>Persistence Storage</label>
        <input type="checkbox" id="node-input-persistence">
    </div>
    <div class="form-row" id="persistenceDiv">
        <label for="node-input-persistenceStorage"><i class="fa fa-tag"></i>Persistent Storage in Mb</label>
        <input type="number" id="node-input-persistenceStorage">
    </div>-->
    <div class="form-row">
        <label for="node-input-jobTimeout"><i class="fa fa-tag"></i> Job Timeout</label>
        <input type="text" id="node-input-jobTimeout" placeholder="300">
    </div>
    <div class="form-row node-input-mail-container-row"></i> Mail User</label>
        <ol id="node-input-mail-container"></ol>
    </div>

    
</script>

<script type="text/markdown" data-help-name="mailserver-start">
Creates a file.

### Inputs

: msg.payload (dictionary):  A dictionary containing the parameter for creating the file.

### Outputs

1. Standard output
: msg.payload (string) : The standard output of the executed ansible job.

2. Job success
: msg.payload (list) : A list of job results if the job was finished successfully.

3. Job failed (partially)
: msg.payload (list) : A list of job results if the job failed (partially).

### Details

The following attributes can be set via `msg.payload`:

```
{
    path: "/example/path"                       # required, must be an absoulte file path
    mode: "0644",                               # optional, file mode
    owner: "user",                              # optional, owner of the file
    group: "usergroup",                         # optional, group of the file
    content: "This is the file content."        # optional, plain text or base64-encoded string, default: false
    isBase64Content: true | false               # optional, if true the content will be base64-decoded on the host
}
```
If the file already exists, it will be overwritten with the given content value. To modify the file attributes use 
the "Modify File" node.

### References

Structure of a job response: https://docs.ansible.com/ansible-tower/3.2.3/html/towerapi/job_list.html#results

Ansible copy module: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html
</script>